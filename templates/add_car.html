{% extends "base.html" %}

{% block title %}ุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ - ูุธุงู ุฅุฏุงุฑุฉ ุดุงูู{% endblock %}

{% block page_title %}ุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-car me-2"></i>ุฅุถุงูุฉ ุณูุงุฑุฉ ุฌุฏูุฏุฉ</h5>
            </div>
            <div class="card-body">
                <form method="POST" id="carForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="brand" class="form-label">ุงููุงุฑูุฉ <span class="text-danger">*</span></label>
                            <select class="form-control" id="brand" name="brand" required>
                                <option value="">ุงุฎุชุฑ ุงููุงุฑูุฉ</option>
                                <option value="ุชูููุชุง">ุชูููุชุง</option>
                                <option value="ูููุฏุง">ูููุฏุง</option>
                                <option value="ููุณุงู">ููุณุงู</option>
                                <option value="ููููุฏุงู">ููููุฏุงู</option>
                                <option value="ููุง">ููุง</option>
                                <option value="ูุงุฒุฏุง">ูุงุฒุฏุง</option>
                                <option value="ููุชุณูุจูุดู">ููุชุณูุจูุดู</option>
                                <option value="ููุฑุฏ">ููุฑุฏ</option>
                                <option value="ุดููุฑูููู">ุดููุฑูููู</option>
                                <option value="ุจู ุฅู ุฏุจููู">ุจู ุฅู ุฏุจููู</option>
                                <option value="ูุฑุณูุฏุณ">ูุฑุณูุฏุณ</option>
                                <option value="ุฃูุฏู">ุฃูุฏู</option>
                                <option value="ููุฒุณ">ููุฒุณ</option>
                                <option value="ุฃุฎุฑู">ุฃุฎุฑู</option>
                            </select>
                            <div class="invalid-feedback">ูุฑุฌู ุงุฎุชูุงุฑ ุงููุงุฑูุฉ</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="model" class="form-label">ุงูููุฏูู <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="model" name="model" required placeholder="ูุซุงู: ูุงูุฑูุ ุฃููุฑุฏุ ุงูุชููุง">
                            <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุงูููุฏูู</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="year" class="form-label">ุณูุฉ ุงูุตูุน <span class="text-danger">*</span></label>
                            <select class="form-control" id="year" name="year" required>
                                <option value="">ุงุฎุชุฑ ุงูุณูุฉ</option>
                            </select>
                            <div class="invalid-feedback">ูุฑุฌู ุงุฎุชูุงุฑ ุณูุฉ ุงูุตูุน</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="license_plate" class="form-label">ุฑูู ุงูููุญุฉ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="license_plate" name="license_plate" required placeholder="ูุซุงู: ุฃ ุจ ุฌ 1234">
                            <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงูููุญุฉ</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">ุงูููู</label>
                            <select class="form-control" id="color" name="color">
                                <option value="">ุงุฎุชุฑ ุงูููู</option>
                                <option value="ุฃุจูุถ">ุฃุจูุถ</option>
                                <option value="ุฃุณูุฏ">ุฃุณูุฏ</option>
                                <option value="ุฃุญูุฑ">ุฃุญูุฑ</option>
                                <option value="ุฃุฒุฑู">ุฃุฒุฑู</option>
                                <option value="ุฃุฎุถุฑ">ุฃุฎุถุฑ</option>
                                <option value="ุฃุตูุฑ">ุฃุตูุฑ</option>
                                <option value="ุฑูุงุฏู">ุฑูุงุฏู</option>
                                <option value="ุจูู">ุจูู</option>
                                <option value="ูุถู">ูุถู</option>
                                <option value="ุฐูุจู">ุฐูุจู</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">ุงูุญุงูุฉ <span class="text-danger">*</span></label>
                            <select class="form-control" id="status" name="status" required>
                                <option value="ูุชุงุญ">ูุชุงุญ</option>
                                <option value="ูุณุชุฃุฌุฑ">ูุณุชุฃุฌุฑ</option>
                                <option value="ุตูุงูุฉ">ุตูุงูุฉ</option>
                                <option value="ุบูุฑ ูุชุงุญ">ุบูุฑ ูุชุงุญ</option>
                            </select>
                            <div class="invalid-feedback">ูุฑุฌู ุงุฎุชูุงุฑ ุงูุญุงูุฉ</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="purchase_price" class="form-label">ุณุนุฑ ุงูุดุฑุงุก (ุฑูุงู)</label>
                            <input type="number" class="form-control" id="purchase_price" name="purchase_price" min="0" step="0.01" placeholder="0.00">
                            <div class="form-text">ุงุชุฑูู ูุงุฑุบุงู ุฅุฐุง ูู ููู ูุนุฑููุงู</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="current_value" class="form-label">ุงููููุฉ ุงูุญุงููุฉ (ุฑูุงู)</label>
                            <input type="number" class="form-control" id="current_value" name="current_value" min="0" step="0.01" placeholder="0.00">
                            <div class="form-text">ุงููููุฉ ุงูุชูุฏูุฑูุฉ ุงูุญุงููุฉ ููุณูุงุฑุฉ</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="responsible_employee" class="form-label">๐ก ุงูููุธู ุงููุณุคูู (ุงุฎุชูุงุฑู)</label>
                            <select class="form-control" id="responsible_employee" name="responsible_employee">
                                <option value="">-- ุงุฎุชุฑ ุงูููุธู ุงููุณุคูู --</option>
                                {% for employee in employees %}
                                <option value="{{ employee[0] }}">{{ employee[2] }} - {{ employee[1] }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">๐ก ููููู ุฑุจุท ุงูุณูุงุฑุฉ ุจููุธู ูุณุคูู (ุบูุฑ ุฅูุฒุงูู)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="insurance_expiry" class="form-label">ุชุงุฑูุฎ ุงูุชูุงุก ุงูุชุฃููู (ุงุฎุชูุงุฑู)</label>
                            <input type="date" class="form-control" id="insurance_expiry" name="insurance_expiry">
                            <div class="form-text">ุชุงุฑูุฎ ุงูุชูุงุก ุชุฃููู ุงูุณูุงุฑุฉ</div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('cars') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-right me-2"></i>ุงูุนูุฏุฉ ูููุงุฆูุฉ
                                </a>
                                <div>
                                    <button type="reset" class="btn btn-outline-secondary me-2">
                                        <i class="fas fa-undo me-2"></i>ุฅุนุงุฏุฉ ุชุนููู
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>ุญูุธ ุงูุณูุงุฑุฉ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ูุนุงููุฉ ุงูุจูุงูุงุช -->
<div class="row justify-content-center mt-4">
    <div class="col-lg-8">
        <div class="card" id="previewCard" style="display: none;">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-eye me-2"></i>ูุนุงููุฉ ุงูุณูุงุฑุฉ</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="car-preview-item">
                            <i class="fas fa-car me-2"></i>
                            <strong>ุงููุฑูุจุฉ:</strong> <span id="previewCar">-</span>
                        </div>
                        <div class="car-preview-item">
                            <i class="fas fa-calendar me-2"></i>
                            <strong>ุงูุณูุฉ:</strong> <span id="previewYear">-</span>
                        </div>
                        <div class="car-preview-item">
                            <i class="fas fa-id-card me-2"></i>
                            <strong>ุฑูู ุงูููุญุฉ:</strong> <span id="previewPlate">-</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="car-preview-item">
                            <i class="fas fa-palette me-2"></i>
                            <strong>ุงูููู:</strong> <span id="previewColor">-</span>
                        </div>
                        <div class="car-preview-item">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>ุงูุญุงูุฉ:</strong> <span id="previewStatus">-</span>
                        </div>
                        <div class="car-preview-item">
                            <i class="fas fa-money-bill-wave me-2"></i>
                            <strong>ุณุนุฑ ุงูุดุฑุงุก:</strong> <span id="previewPrice">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control:focus {
        border-color: #17a2b8;
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
    }
    
    .was-validated .form-control:valid {
        border-color: #28a745;
    }
    
    .was-validated .form-control:invalid {
        border-color: #dc3545;
    }
    
    .car-preview-item {
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    
    .car-preview-item:last-child {
        border-bottom: none;
    }
    
    .car-preview-item i {
        color: #17a2b8;
        width: 20px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('carForm');
        const previewCard = document.getElementById('previewCard');
        
        // ููุก ูุงุฆูุฉ ุงูุณููุงุช
        const yearSelect = document.getElementById('year');
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 1980; year--) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearSelect.appendChild(option);
        }
        
        // ูุนุงููุฉ ุงูุจูุงูุงุช ุฃุซูุงุก ุงููุชุงุจุฉ
        const inputs = form.querySelectorAll('input, select');
        inputs.forEach(input => {
            input.addEventListener('input', updatePreview);
            input.addEventListener('change', updatePreview);
        });
        
        function updatePreview() {
            const brand = document.getElementById('brand').value;
            const model = document.getElementById('model').value;
            const year = document.getElementById('year').value;
            const licensePlate = document.getElementById('license_plate').value;
            const color = document.getElementById('color').value;
            const status = document.getElementById('status').value;
            const purchasePrice = document.getElementById('purchase_price').value;
            
            if (brand || model || year || licensePlate) {
                document.getElementById('previewCar').textContent = 
                    (brand && model) ? `${brand} ${model}` : (brand || model || '-');
                document.getElementById('previewYear').textContent = year || '-';
                document.getElementById('previewPlate').textContent = licensePlate || '-';
                document.getElementById('previewColor').textContent = color || '-';
                document.getElementById('previewStatus').textContent = status || '-';
                document.getElementById('previewPrice').textContent = 
                    purchasePrice ? formatCurrency(purchasePrice) : '-';
                
                previewCard.style.display = 'block';
            } else {
                previewCard.style.display = 'none';
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('ar-SA', {
                style: 'currency',
                currency: 'SAR',
                minimumFractionDigits: 0
            }).format(amount);
        }
        
        // ุงูุชุญูู ูู ุตุญุฉ ุงููููุฐุฌ
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
        
        // ุงูุชุญูู ูู ุฑูู ุงูููุญุฉ
        const licensePlateInput = document.getElementById('license_plate');
        licensePlateInput.addEventListener('input', function() {
            const plate = this.value.trim();
            if (plate.length > 0 && plate.length < 3) {
                this.setCustomValidity('ุฑูู ุงูููุญุฉ ูุตูุฑ ุฌุฏุงู');
            } else {
                this.setCustomValidity('');
            }
        });
        
        // ุชุญุฏูุซ ุงููููุฉ ุงูุญุงููุฉ ุชููุงุฆูุงู ุนูุฏ ุฅุฏุฎุงู ุณุนุฑ ุงูุดุฑุงุก
        const purchasePriceInput = document.getElementById('purchase_price');
        const currentValueInput = document.getElementById('current_value');
        
        purchasePriceInput.addEventListener('input', function() {
            const purchasePrice = parseFloat(this.value);
            if (purchasePrice && !currentValueInput.value) {
                // ุชูุฏูุฑ ุงููููุฉ ุงูุญุงููุฉ ุจูุงุกู ุนูู ุงูุนูุฑ (ุชูุฏูุฑ ุชูุฑูุจู)
                const year = parseInt(document.getElementById('year').value);
                if (year) {
                    const currentYear = new Date().getFullYear();
                    const age = currentYear - year;
                    const depreciationRate = Math.min(age * 0.1, 0.7); // 10% ุณูููุงู ุญุชู 70%
                    const estimatedValue = purchasePrice * (1 - depreciationRate);
                    currentValueInput.value = Math.round(estimatedValue);
                }
            }
        });
        
        // ุชุฃุซูุฑ ุงูุชุฑููุฒ ุนูู ุงูุญููู
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });
        
        // ุชุญุฏูุซ ุฎูุงุฑุงุช ุงูููุฏูู ุจูุงุกู ุนูู ุงููุงุฑูุฉ
        const brandSelect = document.getElementById('brand');
        const modelInput = document.getElementById('model');
        
        const brandModels = {
            'ุชูููุชุง': ['ูุงูุฑู', 'ููุฑููุง', 'ุฃูุงููู', 'ูุงุฑุณ', 'ุฑุงู 4', 'ูุงููุงูุฏุฑ', 'ุจุฑุงุฏู', 'ูุงูุฏ ูุฑูุฒุฑ'],
            'ูููุฏุง': ['ุฃููุฑุฏ', 'ุณูููู', 'ุณู ุขุฑ ูู', 'ุจุงูููุช', 'ุฃูุฏูุณู'],
            'ููุณุงู': ['ุงูุชููุง', 'ุณูุชุฑุง', 'ููุณููุง', 'ุจุงุชุฑูู', 'ุฅูุณ ุชุฑูู'],
            'ููููุฏุงู': ['ุฅููุชุฑุง', 'ุณููุงุชุง', 'ุชูุณุงู', 'ุณุงูุชุง ูู', 'ุฃูุณูุช'],
            'ููุง': ['ุฃูุจุชููุง', 'ุณูุฑุงุชู', 'ุณูุฑููุชู', 'ุณุจูุฑุชุงุฌ', 'ุฑูู']
        };
        
        brandSelect.addEventListener('change', function() {
            const selectedBrand = this.value;
            if (brandModels[selectedBrand]) {
                // ุชุญููู ุญูู ุงูููุฏูู ุฅูู ูุงุฆูุฉ ููุณุฏูุฉ
                const modelSelect = document.createElement('select');
                modelSelect.className = modelInput.className;
                modelSelect.id = modelInput.id;
                modelSelect.name = modelInput.name;
                modelSelect.required = modelInput.required;
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'ุงุฎุชุฑ ุงูููุฏูู';
                modelSelect.appendChild(defaultOption);
                
                brandModels[selectedBrand].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
                
                const otherOption = document.createElement('option');
                otherOption.value = 'ุฃุฎุฑู';
                otherOption.textContent = 'ุฃุฎุฑู';
                modelSelect.appendChild(otherOption);
                
                modelInput.parentNode.replaceChild(modelSelect, modelInput);
                modelSelect.addEventListener('change', updatePreview);
            }
        });
    });
</script>
{% endblock %}